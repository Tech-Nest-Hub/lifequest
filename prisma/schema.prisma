generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ----------------------------
// Enums
// ----------------------------
enum Gender {
  MALE
  FEMALE
}

enum Role {
  USER
  ADMIN
}

enum UserQuestStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  CLAIMED
  REJECTED
}
enum QuestType {
  DAILY
  MAIN
  SIDE
  POMODORO
  PREMIUM
}
// ----------------------------
// Users (Players / Characters)
// ----------------------------
model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String? // optional for OAuth users
  createdAt DateTime @default(now())

  // profile / character attributes
  gender    Gender   @default(MALE)
  age       Int?
  role      Role     @default(USER)

  race      Race?    @relation(fields: [raceId], references: [id])
  raceId    String?
  subrace   Subrace? @relation(fields: [subraceId], references: [id])
  subraceId String?
  class     Class?   @relation(fields: [classId], references: [id])
  classId   String?

  level Int  @default(1)
  xp    Int  @default(0)
  stats Json @default("{}")

  health Int  @default(100)
  energy Int  @default(100)
  skills Json @default("{}")
  money  Int  @default(0)

  // relations
  tasks           Task[]           // personal quick tasks
  badges          Badge[]
  equipment       Equipment[]
  userQuests      UserQuest[]      // accepted quests
  pomodoroSession PomodoroSession[]// sessions run by user
  questRequests   QuestRequest[]   // user-submitted quest requests

  inventories Inventory[]
}

// ----------------------------
// Races & Subraces
// ----------------------------
model Race {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  attributes  Json?     // starting bonuses
  icon        String?
  subraces    Subrace[]
  users       User[]
}

model Subrace {
  id     String @id @default(uuid())
  name   String
  traits Json?
  race   Race   @relation(fields: [raceId], references: [id])
  raceId String
  users  User[]
}

// ----------------------------
// Classes
// ----------------------------
model Class {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?
  attributes  Json?
  icon        String?
  users       User[]
}

// ----------------------------
// Equipment (tools for progression)
// ----------------------------
model Equipment {
  id         String @id @default(uuid())
  user       User   @relation(fields: [userId], references: [id])
  userId     String
  name       String
  type       String // Tool, Armor, Consumable, Adventuring Gear
  properties Json?
  quantity   Int    @default(1)
  value      Int?
}

// ----------------------------
// Tasks = simple user tasks (existing model)
// ----------------------------
model Task {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  title       String
  description String?
  xpReward    Int
  statEffects Json?   // e.g., { health: +5, energy: +3, skills: { learning: +2 } }
  completed   Boolean  @default(false)
  createdAt   DateTime @default(now())
}

// ----------------------------
// Badges / Achievements
// ----------------------------
model Badge {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  name        String
  description String?
  unlockedAt  DateTime @default(now())
}

// ----------------------------
// MASTER Quest: blueprint of a quest (system-level)
// ----------------------------
model Quest {
  id             String   @id @default(uuid())
  title          String
  slug           String   @unique
  description    String?
  category       String?     // e.g., "physical","social","mind"
  xpReward       Int        @default(100)
  currencyReward Int?       // optional money/coins
  statEffects    Json?      // e.g., { "strength": 2 }
  // requiredAction stores the verification/target for the quest, e.g.
  // { "type":"pomodoro", "minutes":25 } or { "type":"manual","check":"photo" }
  requiredAction Json?
  isRepeatable   Boolean    @default(false)
  minLevel       Int?       // min level to unlock
  createdBy      String?    // admin who created it
  createdAt      DateTime   @default(now())

   type        QuestType @default(MAIN)  // Add this line
  isDaily     Boolean   @default(false) // Or use this for simple daily flag
  maxCompletions Int?   @default(1)     // For daily limits

  // Relations
  userQuests UserQuest[]
}

// ----------------------------
// UserQuest: per-player accepted quest + progress + verification
// ----------------------------
model UserQuest {
  id         String         @id @default(uuid())
  user       User           @relation(fields: [userId], references: [id])
  userId     String
  quest      Quest          @relation(fields: [questId], references: [id])
  questId    String
  status     UserQuestStatus @default(NOT_STARTED)
  // progress: freeform JSON, e.g., { "pomodorosCompleted": 2, "minutes": 50 }
  progress   Json?          
  // evidence/proof may be a URL or note (admin can inspect)
  proof      String?        
  startedAt  DateTime?
  completedAt DateTime?
  claimedAt  DateTime?
  createdAt  DateTime       @default(now())

  // Verification audit (who approved/rejected)
  reviewedBy String?        // admin userId
  reviewNote String?
  reviewedAt DateTime?

  pomodoroSessions PomodoroSession[]
}

// ----------------------------
// Pomodoro sessions linked to quests
// ----------------------------
model PomodoroSession {
  id           String   @id @default(uuid())
  user         User     @relation(fields: [userId], references: [id])
  userId       String
  // optional link to a userQuest to automatically increment progress
  userQuest    UserQuest? @relation(fields: [userQuestId], references: [id])
  userQuestId  String?
  category     String?   // "study","exercise","creative"
  focusMinutes Int      @default(25)
  breakMinutes Int      @default(5)
  completed    Boolean  @default(false)
  xpAwarded    Int?     
  startedAt    DateTime @default(now())
  endedAt      DateTime?
}

// ----------------------------
// Quest request (user asks admin to add a new quest to master list)
// ----------------------------
model QuestRequest {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  title       String
  description String?
  category    String?
  xpReward    Int?     @default(100)
  requiredAction Json?
  status      UserQuestStatus @default(NOT_STARTED) // reuse statuses: NOT_STARTED => pending, COMPLETED => approved, REJECTED => rejected (you can map)
  adminNote   String?
  reviewedBy  String?
  reviewedAt  DateTime?
  createdAt   DateTime @default(now())
}

// ----------------------------
// Optional: Inventory (if you later want item-based quests)
// ----------------------------
model Inventory {
  id        String @id @default(uuid())
  user      User   @relation(fields: [userId], references: [id])
  userId    String
  itemKey   String
  quantity  Int     @default(0)
  updatedAt DateTime @updatedAt
}
